<!DOCTYPE html>
<html lang="th">
<head>
    <link rel="manifest" href="manifest.json">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚òï ‡∏£‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡πÅ‡∏ü‡∏´‡∏≠‡∏°‡∏Å‡∏∏‡πà‡∏ô | POS & Loyalty (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡∏°‡πà)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script type="module" src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js"></script>
    
    <style>
        /* Custom Styles for Blue/Yellow Theme and Layout */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@100..900&display=swap');
        body { font-family: 'Noto Sans Thai', sans-serif; background-color: #f0f8ff; } 
        .header-bg { background-color: #007bff; } 
        .accent-color { background-color: #ffc107; } 
        .btn-primary { background-color: #007bff; color: white; transition: background-color 0.2s; }
        .btn-primary:hover { background-color: #0056b3; }
        .btn-secondary { background-color: #6c757d; color: white; transition: background-color 0.2s; }
        .btn-secondary:hover { background-color: #5a6268; }
        .card-bg { background-color: white; }
        
        /* Fixed Cart and Menu for POS Layout */
        #pos-layout {
            display: grid;
            grid-template-columns: 2fr 1fr; /* Menu (2) and Cart (1) */
            height: calc(100vh - 64px); /* Full height minus header */
            overflow: hidden;
        }
        
        .tab-button.active {
            border-bottom: 3px solid #ffc107;
            color: #007bff;
            font-weight: 600;
        }
        
        /* Hide scrollbar for Menu and Cart but still allow scroll */
        .overflow-y-scroll::-webkit-scrollbar {
            display: none;
        }
        .overflow-y-scroll {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
    </style>
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icons/icon-192x192.png">
    <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"> <title>‚òï ‡∏£‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡πÅ‡∏ü‡∏´‡∏≠‡∏°‡∏Å‡∏£‡∏∏‡πà‡∏ô | POS & Loyalty</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-250.png"> <meta name="theme-color" content="#007bff">
    </head>
</head>
<body class="min-h-screen">

    <div id="receipt-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-[110]">
        <div class="bg-white p-8 rounded-lg shadow-2xl max-w-sm w-full font-mono">
            <div class="text-center border-b pb-3 mb-3">
                <img src="C:\Users\‡∏à‡∏±‡∏Å‡∏£‡∏†‡∏±‡∏ó‡∏£ ‡∏ï‡∏≤‡∏î‡∏µ\Desktop\coffeemanagment/Logo.png" alt="Logo" class="mx-auto mt-1 h-40">
                <h2 class="text-2xl font-bold text-blue-800 mb-1">‚òï ‡∏£‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡πÅ‡∏ü‡∏´‡∏≠‡∏°‡∏Å‡∏∏‡πà‡∏ô</h2>
                <p class="text-sm text-gray-600">‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏¢‡πà‡∏≠</p>
            </div>
            
            <div id="receipt-details" class="text-xs mb-3 space-y-1 border-b pb-3">
                </div>
            
            <div id="receipt-items" class="mb-3 border-b pb-3">
                </div>
            
            <div id="receipt-summary" class="mb-4">
                </div>
            
            <div class="text-center text-xs text-gray-600">
                <p>--- ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ ---</p>
            </div>
            
            <button onclick="document.getElementById('receipt-modal').classList.add('hidden')" class="mt-4 w-full p-2 rounded-lg bg-green-500 text-white hover:bg-green-600 font-semibold">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</button>
            <button onclick="printReceipt()" class="mt-2 w-full p-2 rounded-lg bg-blue-500 text-white hover:bg-blue-600 font-semibold">‡∏û‡∏¥‡∏°‡∏û‡πå / PDF</button>
        </div>
    </div>
    
    <div id="auth-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-2xl max-w-sm w-full">
            <h2 class="text-2xl font-bold text-center mb-6 text-blue-800">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö / ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</h2>
            
            <form id="auth-form" class="space-y-4">
                <div>
                    <label for="auth-email" class="block text-sm font-medium text-gray-700">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                    <input type="email" id="auth-email" required class="w-full p-3 border border-gray-300 rounded-lg mt-1 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="auth-password" class="block text-sm font-medium text-gray-700">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                    <input type="password" id="auth-password" required class="w-full p-3 border border-gray-300 rounded-lg mt-1 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div id="register-fields" class="space-y-4 hidden">
                    <div>
                        <label for="auth-name" class="block text-sm font-medium text-gray-700">‡∏ä‡∏∑‡πà‡∏≠ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô)</label>
                        <input type="text" id="auth-name" class="w-full p-3 border border-gray-300 rounded-lg mt-1">
                    </div>
                </div>
                <button type="submit" id="auth-submit-btn" class="btn-primary w-full p-3 rounded-lg font-semibold">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
            </form>
            
            <div class="mt-4 text-center">
                <button id="toggle-auth-mode" class="text-sm text-blue-600 hover:text-blue-800">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ? ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
            </div>
            <p id="auth-error-message" class="text-red-500 text-sm mt-3 text-center"></p>
        </div>
    </div>

    <header id="app-header" class="header-bg p-4 flex justify-between items-center shadow-lg h-16 hidden">
        <h1 class="text-2xl font-bold text-white">‚òï POS System</h1>
        <nav>
            <button id="nav-pos" onclick="showTab('pos')" class="tab-button text-white p-2 mx-2 hover:bg-blue-600 rounded active">‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô (POS)</button>
            <button id="nav-admin" onclick="showTab('admin')" class="tab-button text-white p-2 mx-2 hover:bg-blue-600 rounded hidden">‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô (Admin)</button>
        </nav>
        <div class="flex items-center space-x-4">
            <span id="user-info" class="text-white text-sm"></span>
            <button onclick="logout()" class="btn-secondary px-3 py-1 rounded-lg font-semibold">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
    </header>

    <main id="pos-tab" class="hidden">
        <div id="pos-layout">
            
            <div class="p-4 overflow-y-scroll bg-white">
                <h2 class="text-2xl font-bold text-blue-800 mb-4 border-b pb-2">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
                
                <div class="flex space-x-2 mb-4" id="category-filter-container">
                    </div>
                
                <div id="product-list" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                    </div>
            </div>

            <div class="bg-gray-100 flex flex-col border-l border-gray-300">
                
                <div class="p-4 border-t border-gray-300 bg-white shadow-lg">
                    <h3 class="text-lg font-bold text-gray-700 mb-2">‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å (Loyalty)</h3>
                    <div class="space-y-2 mb-2">
                        <input type="tel" id="loyalty-phone-input" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤" class="w-full p-2 border rounded-lg text-sm">
                        <input type="text" id="loyalty-first-name-input" placeholder="‡∏ä‡∏∑‡πà‡∏≠ (‡∏ñ‡πâ‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà)" class="w-full p-2 border rounded-lg text-sm">
                        <input type="text" id="loyalty-last-name-input" placeholder="‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• (‡∏ñ‡πâ‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà)" class="w-full p-2 border rounded-lg text-sm">
                        <button onclick="findCustomer()" class="w-full bg-yellow-500 text-white p-2 rounded-lg text-sm hover:bg-yellow-600 font-semibold">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ / ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
                    </div>
                    <div id="customer-info" class="text-sm">
                        <p class="text-red-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</p>
                    </div>
                </div>

                <div class="p-4 overflow-y-scroll flex-grow">
                    <h2 class="text-2xl font-bold text-blue-800 mb-4 border-b pb-2">‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
                    <div id="cart-list" class="space-y-3">
                        </div>
                </div>

                <div class="p-4 border-t border-gray-300 bg-white shadow-2xl">
                    <div id="cart-summary" class="text-xl font-extrabold text-right mb-4">
                        ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: <span class="text-blue-600">0.00</span> ‡∏ö‡∏≤‡∏ó
                    </div>
                    <button onclick="openPaymentModal()" id="checkout-btn" class="w-full p-3 rounded-lg bg-green-500 text-white hover:bg-green-600 font-extrabold" disabled>
                        ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
                    </button>
                </div>
            </div>
        </div>
    </main>

    <div id="admin-tab" class="p-4 hidden">
        <h2 class="text-3xl font-bold text-blue-800 mb-6">‚öôÔ∏è ‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô (Admin Dashboard)</h2>
        
        <div class="flex space-x-4 mb-6 border-b pb-2">
            <button onclick="showAdminTab('sales')" id="admin-nav-sales" class="tab-button p-2 text-gray-600 active">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</button>
            <button onclick="showAdminTab('orders')" id="admin-nav-orders" class="tab-button p-2 text-gray-600">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</button>
            <button onclick="showAdminTab('products')" id="admin-nav-products" class="tab-button p-2 text-gray-600">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
            <button onclick="showAdminTab('users')" id="admin-nav-users" class="tab-button p-2 text-gray-600">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</button>
        </div>
        
        <div id="admin-tab-sales" class="bg-white p-6 rounded-lg shadow-xl">
            <h3 class="text-2xl font-bold mb-4">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</h3>
            
            <div class="flex space-x-3 mb-4">
                <button onclick="renderSalesReport('daily')" id="filter-daily" class="px-4 py-2 rounded-lg font-semibold bg-blue-100 hover:bg-blue-200 text-blue-800">‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</button>
                <button onclick="renderSalesReport('weekly')" id="filter-weekly" class="px-4 py-2 rounded-lg font-semibold bg-gray-200 hover:bg-gray-300 text-gray-700">‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</button>
                <button onclick="renderSalesReport('monthly')" id="filter-monthly" class="px-4 py-2 rounded-lg font-semibold bg-gray-200 hover:bg-gray-300 text-gray-700">‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</button>
            </div>
            
            <button onclick="exportSalesDataToCSV()" class="btn-primary px-4 py-2 rounded-lg font-semibold mb-4">Export ‡πÄ‡∏õ‡πá‡∏ô Excel/Google Sheet</button>
            
            <div class="grid grid-cols-3 gap-4 mb-6">
                <div class="p-4 bg-blue-100 rounded-lg shadow">
                    <p class="text-sm text-blue-800">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°</p>
                    <p id="report-total-sales" class="text-2xl font-bold text-blue-900">0.00 ‡∏ø</p>
                </div>
                <div class="p-4 bg-yellow-100 rounded-lg shadow">
                    <p class="text-sm text-yellow-800">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå</p>
                    <p id="report-total-orders" class="text-2xl font-bold text-yellow-900">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
                </div>
                <div class="p-4 bg-green-100 rounded-lg shadow">
                    <p class="text-sm text-green-800">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</p>
                    <p id="report-total-customers" class="text-2xl font-bold text-green-900">0 ‡∏Ñ‡∏ô</p>
                </div>
            </div>
            
            <div style="height: 400px;" class="bg-gray-50 p-4 rounded-lg">
                <canvas id="salesChart"></canvas>
            </div>
        </div>
        
        <div id="admin-tab-orders" class="hidden bg-white p-6 rounded-lg shadow-xl">
            <h3 class="text-2xl font-bold mb-4 text-blue-800">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
            <div class="mb-4">
                <input type="text" id="order-search-input" oninput="filterOrderHistory()" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢ ID, ‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤, ‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô" class="w-full p-2 border rounded-lg max-w-sm">
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</th>
                            <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</th>
                            <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
                        </tr>
                    </thead>
                    <tbody id="order-history-list" class="bg-white divide-y divide-gray-200">
                        </tbody>
                </table>
            </div>
        </div>
        
        <div id="admin-tab-products" class="hidden grid grid-cols-3 gap-6">
            <div class="col-span-1 bg-white p-6 rounded-lg shadow-xl h-fit">
                <h3 class="text-xl font-bold mb-4 text-blue-700">‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
                <form id="menu-form" class="space-y-3">
                    <input type="hidden" id="product-id">
                    <label class="block text-sm font-medium text-gray-700">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
                    <input type="text" id="product-name" required class="w-full p-2 border rounded-lg">
                    
                    <label class="block text-sm font-medium text-gray-700">‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ö‡∏≤‡∏ó)</label>
                    <input type="number" id="product-price" step="0.01" required class="w-full p-2 border rounded-lg">
                    
                    <label class="block text-sm font-medium text-gray-700">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
                    <input type="text" id="product-category" required class="w-full p-2 border rounded-lg">
                    
                    <label class="block text-sm font-medium text-gray-700">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (URL)</label>
                    <input type="url" id="product-image-url" placeholder="https://example.com/coffee.jpg" class="w-full p-2 border rounded-lg">
                    
                    <button type="submit" id="menu-submit-btn" class="btn-primary w-full p-2 rounded-lg font-semibold mt-4">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</button>
                    <button type="button" onclick="resetMenuForm()" class="btn-secondary w-full p-2 rounded-lg font-semibold mt-2">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                </form>
            </div>
            <div class="col-span-2 bg-white p-6 rounded-lg shadow-xl">
                <h3 class="text-xl font-bold mb-4 text-blue-700">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏ä‡∏∑‡πà‡∏≠</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏£‡∏≤‡∏Ñ‡∏≤</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody id="admin-product-list" class="bg-white divide-y divide-gray-200">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div id="admin-tab-users" class="hidden bg-white p-6 rounded-lg shadow-xl">
            <h3 class="text-2xl font-bold mb-4">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (Admin Only)</h3>
            <div id="admin-user-list" class="space-y-4">
                </div>
        </div>

    </div>

    <div id="payment-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
        <div class="card-bg p-6 rounded-lg shadow-2xl max-w-lg w-full">
            <h3 class="text-2xl font-bold text-blue-700 mb-4 border-b pb-2">‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h3>
            
            <div class="text-lg font-semibold mb-4 p-3 bg-blue-50 rounded-lg">
                <p id="payment-summary">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∞: <span class="text-red-600 font-extrabold">0.00</span> ‡∏ö‡∏≤‡∏ó</p>
            </div>

            <div id="loyalty-redeem-section" class="bg-yellow-50 p-3 rounded-lg mb-4 hidden">
                <p class="font-bold text-yellow-800 mb-2">üí∞ ‡πÅ‡∏•‡∏Å‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏∞‡∏™‡∏°</p>
                <div id="current-points-info" class="text-sm mb-2"></div>
                <div class="flex space-x-2">
                    <input type="number" id="redeem-points-input" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ï‡πâ‡∏°‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÅ‡∏•‡∏Å (100 ‡πÅ‡∏ï‡πâ‡∏° = 1 ‡∏ö‡∏≤‡∏ó)" class="w-full p-2 border rounded-lg text-sm">
                    <button onclick="redeemPoints()" class="bg-yellow-500 text-white px-3 py-1 rounded-lg text-sm hover:bg-yellow-600">‡πÅ‡∏•‡∏Å‡πÅ‡∏ï‡πâ‡∏°</button>
                </div>
                <p id="redeem-info" class="text-sm mt-1 text-green-600"></p>
            </div>

            <div class="bg-red-50 p-3 rounded-lg mb-4">
                <p class="font-bold text-red-800 mb-2">üè∑Ô∏è ‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</p>
                <div class="flex space-x-2 mt-1">
                    <input type="text" id="discount-code-input" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î" class="w-full p-2 border rounded-lg text-sm">
                    <button onclick="applyDiscountCode()" class="bg-red-500 text-white px-3 py-1 rounded-lg text-sm hover:bg-red-600 font-semibold">‡πÉ‡∏ä‡πâ‡πÇ‡∏Ñ‡πâ‡∏î</button>
                </div>
                <p id="discount-code-info" class="text-sm mt-1 text-green-600"></p>
            </div>
            
            <div class="bg-blue-50 p-3 rounded-lg mb-4">
                <p class="font-bold text-blue-800 mb-2">üí∞ ‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏≠‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î)</p>
                <div>
                    <label for="cash-received-input" class="block text-sm font-medium text-gray-700 mb-1">‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡∏ö‡∏≤‡∏ó)</label>
                    <input type="number" id="cash-received-input" placeholder="0.00" step="0.01" oninput="calculateChange()" class="w-full p-2 border border-blue-300 rounded-lg text-lg font-bold">
                </div>
                <div id="change-info" class="text-lg font-bold mt-2 text-right">
                    ‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏≠‡∏ô: <span class="text-green-600">0.00</span> ‡∏ö‡∏≤‡∏ó
                </div>
            </div>
            
            <div id="payment-options" class="space-y-3">
                <p class="text-md font-medium mb-2 text-gray-700">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô:</p>
                <button onclick="simulatePayment('Cash')" class="w-full p-3 rounded-lg bg-green-500 text-white hover:bg-green-600 font-semibold" disabled>‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î (Cash)</button> 
                <button onclick="simulatePayment('Credit Card')" class="w-full p-3 rounded-lg bg-blue-500 text-white hover:bg-blue-600 font-semibold">‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï (Credit Card)</button>
                <button onclick="simulatePayment('QR Code')" class="w-full p-3 rounded-lg bg-indigo-500 text-white hover:bg-indigo-600 font-semibold">QR Code Payment</button>
            </div>
            
            <button onclick="document.getElementById('payment-modal').classList.add('hidden')" class="w-full mt-4 p-2 rounded-lg bg-gray-400 text-white hover:bg-gray-500">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        </div>
    </div>

    <div id="custom-alert" class="fixed top-4 right-4 p-4 rounded-lg shadow-lg text-white z-50 transition-transform duration-300 transform translate-x-full hidden" role="alert">
        <span id="alert-message"></span>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js';
        import { getFirestore, collection, getDocs, doc, getDoc, addDoc, updateDoc, deleteDoc, query, where, serverTimestamp, setDoc, limit, orderBy, Timestamp } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js';
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js';

        // ----------------------------------------------------
        // 1. Firebase Configuration (*** ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà config ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà ***)
        // ----------------------------------------------------
        const firebaseConfig = {
            apiKey: "AIzaSyBdrC56tglzi4X65udBBEplPSD-zx6Fzy0",
  authDomain: "projectcoffee-9c463.firebaseapp.com",
  projectId: "projectcoffee-9c463",
  storageBucket: "projectcoffee-9c463.firebasestorage.app",
  messagingSenderId: "239685841742",
  appId: "1:239685841742:web:a569abf31b9739fd27241f",
  measurementId: "G-PD2NKJ4YHG"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // ----------------------------------------------------
        // 2. Global State
        // ----------------------------------------------------
        let cart = [];
        let currentCustomer = null;
        let redemptionAmount = 0;
        let userRole = null;
        let currentUserId = null;
        let myChart = null; 
        
        let discountCodeValue = 0; 
        let staffName = "‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô POS"; 
        
        let allOrdersCache = []; // Cache for order history
        
        // **NEW FIX:** Stores the order objects for the currently viewed report period (for Export)
        let currentFilteredOrders = []; 

        // ----------------------------------------------------
        // 3. Utility Functions
        // ----------------------------------------------------
        
        function showCustomError(message, isError = true) {
            const alertBox = document.getElementById('custom-alert');
            const alertMessage = document.getElementById('alert-message');
            
            alertMessage.textContent = message;
            alertBox.classList.remove('hidden', 'bg-red-500', 'bg-green-500', 'translate-x-full');
            
            if (isError) {
                alertBox.classList.add('bg-red-500');
            } else {
                alertBox.classList.add('bg-green-500');
            }
            
            // Show alert
            setTimeout(() => {
                alertBox.classList.remove('translate-x-full');
                alertBox.classList.add('translate-x-0');
            }, 50);

            // Hide alert
            setTimeout(() => {
                alertBox.classList.add('translate-x-full');
                setTimeout(() => alertBox.classList.add('hidden'), 300);
            }, 4000);
        }

        window.printReceipt = function() {
            const modal = document.getElementById('receipt-modal');
            // ‡∏î‡∏∂‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏î‡πâ‡∏≤‡∏ô‡πÉ‡∏ô
            const receiptContent = modal.querySelector('div.bg-white').outerHTML; 

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå
            const printWindow = window.open('', '', 'height=600,width=800');

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ HTML ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå
            printWindow.document.write('<html><head><title>‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</title>');
            // ‡πÄ‡∏û‡∏¥‡πà‡∏° Stylesheet ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
            printWindow.document.write('<style>body { font-family: "Noto Sans Thai", sans-serif; margin: 0; padding: 20px; } .text-center { text-align: center; } .border-b { border-bottom: 1px solid #ccc; } .pb-3 { padding-bottom: 0.75rem; } .mb-3 { margin-bottom: 0.75rem; } .space-y-1 > * + * { margin-top: 0.25rem; } .font-mono { font-family: monospace; } .flex { display: flex; } .justify-between { justify-content: space-between; } .pt-1 { padding-top: 0.25rem; }</style>');
            printWindow.document.write('</head><body onafterprint="self.close()" >'); // ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÄ‡∏≠‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏™‡∏£‡πá‡∏à
            printWindow.document.write(receiptContent);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            
            // ‡∏™‡∏±‡πà‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå
            printWindow.print();
        };

        // NEW FIX: Date Range Utility for Reports (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á)
        function getDateRange(period) {
            const now = new Date();
            let startDate = new Date();
            // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏´‡πâ endDate ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏™‡∏°‡∏≠
            let endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59, 999); 

            if (period === 'daily') {
                // Start of today
                startDate.setHours(0, 0, 0, 0);
            } else if (period === 'weekly') {
                // Start of the last 7 days (including today)
                startDate.setDate(now.getDate() - 6);
                startDate.setHours(0, 0, 0, 0);
            } else if (period === 'monthly') {
                // Start of the current month
                startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                startDate.setHours(0, 0, 0, 0);
            } else {
                // Default to daily if unknown
                startDate.setHours(0, 0, 0, 0);
            }

            // Convert to Firebase Timestamp for the query
            return { 
                startDate: Timestamp.fromDate(startDate), 
                endDate: Timestamp.fromDate(endDate) 
            };
        }

        // ----------------------------------------------------
        // 4. Authentication Logic
        // ----------------------------------------------------

        // Toggle Login/Register
        document.getElementById('toggle-auth-mode').addEventListener('click', (e) => {
            e.preventDefault();
            const form = document.getElementById('auth-form');
            const submitBtn = document.getElementById('auth-submit-btn');
            const isRegister = form.dataset.mode === 'register';

            if (isRegister) {
                form.dataset.mode = 'login';
                submitBtn.innerText = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö';
                document.getElementById('toggle-auth-mode').innerText = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ? ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô';
                document.getElementById('register-fields').classList.add('hidden');
            } else {
                form.dataset.mode = 'register';
                submitBtn.innerText = '‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô';
                document.getElementById('toggle-auth-mode').innerText = '‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏•‡πâ‡∏ß? ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö';
                document.getElementById('register-fields').classList.remove('hidden');
            }
        });

        // Submit Login/Register
        document.getElementById('auth-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            const name = document.getElementById('auth-name').value;
            const mode = e.target.dataset.mode || 'login';
            const errorElement = document.getElementById('auth-error-message');
            errorElement.textContent = '';

            try {
                if (mode === 'login') {
                    await signInWithEmailAndPassword(auth, email, password);
                } else {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    
                    // Add user to 'users' collection with default 'staff' role
                    await setDoc(doc(db, "users", userCredential.user.uid), {
                        email: email,
                        name: name || 'Staff',
                        role: 'staff' 
                    });
                }
            } catch (error) {
                errorElement.textContent = 'Auth Error: ' + error.message;
            }
        });

        // Auth State Listener (Crucial for role and name retrieval)
        onAuthStateChanged(auth, async (user) => {
            const authModal = document.getElementById('auth-modal');
            
            if (user) {
                currentUserId = user.uid;
                const userDocRef = doc(db, "users", user.uid); 
                const userDoc = await getDoc(userDocRef);
                
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    userRole = userData.role;
                    staffName = userData.name || "‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô POS"; // Get Staff Name
                    
                    initializeAppLayout(true);
                    document.getElementById('user-info').textContent = `${staffName} (${userRole})`;
                    authModal.classList.add('hidden');
                    
                    if (userRole === 'admin') {
                        document.getElementById('nav-admin').classList.remove('hidden');
                        renderAdminUserList();
                        renderSalesReport('daily'); // <<< INITIAL CALL FOR SALES REPORT
                        renderOrderHistory(true); // Pre-fetch and cache orders
                    } else {
                        document.getElementById('nav-admin').classList.add('hidden');
                        // Staff only gets POS view, no initial report rendering
                    }
                    
                    // Load data after successful login
                    fetchProducts();
                } else {
                    // Handle case where user exists in Auth but not in Firestore 
                    showCustomError("‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏≠ Admin ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì", true);
                    initializeAppLayout(false);
                }
            } else {
                initializeAppLayout(false);
                authModal.classList.remove('hidden');
            }
        });

        function initializeAppLayout(isLoggedIn) {
            document.getElementById('app-header').classList.toggle('hidden', !isLoggedIn);
            document.getElementById('pos-tab').classList.toggle('hidden', !isLoggedIn);
            document.getElementById('admin-tab').classList.add('hidden');
            
            if (isLoggedIn) {
                showTab('pos'); // Default to POS tab
            }
        }

        window.logout = () => signOut(auth);

        window.showTab = (tab) => {
            document.querySelectorAll('[id$="-tab"]').forEach(el => el.classList.add('hidden'));
            document.getElementById(`${tab}-tab`).classList.remove('hidden');
            
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`nav-${tab}`).classList.add('active');
            
            if (tab === 'admin') {
                // Ensure only admin can access admin features, but keep the initial call if they succeed in getting here.
                if (userRole !== 'admin') {
                    showCustomError("‚ùå ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏´‡∏ô‡πâ‡∏≤ Admin", true);
                    document.getElementById('admin-tab').classList.add('hidden');
                    document.getElementById('pos-tab').classList.remove('hidden');
                    document.getElementById(`nav-pos`).classList.add('active');
                    return;
                }
                showAdminTab('sales'); // Default admin view
            }
        };
        
        // UPDATED: Calls report/history functions when the admin tab changes
        window.showAdminTab = (tab) => {
            document.querySelectorAll('[id^="admin-tab-"]').forEach(el => el.classList.add('hidden'));
            document.getElementById(`admin-tab-${tab}`).classList.remove('hidden');
            
            document.querySelectorAll('[id^="admin-nav-"]').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`admin-nav-${tab}`).classList.add('active');
            
            if (tab === 'sales') {
                renderSalesReport('daily');
            } else if (tab === 'orders') {
                renderOrderHistory(); // NEW
            } else if (tab === 'products') {
                 renderAdminProductList();
            }
        };

        // ----------------------------------------------------
        // 5. Product (Menu) Logic
        // ----------------------------------------------------
        
        let allProducts = [];
        let activeCategory = 'all';

        async function fetchProducts() {
            const productsCol = collection(db, 'products');
            const productSnapshot = await getDocs(productsCol);
            allProducts = productSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderProductList(allProducts);
            renderCategoryFilters(allProducts);
        }
        
        function renderCategoryFilters(products) {
            const container = document.getElementById('category-filter-container');
            const categories = ['all', ...new Set(products.map(p => p.category))].filter(c => c);

            container.innerHTML = categories.map(cat => `
                <button onclick="filterProducts('${cat}')" 
                        class="px-4 py-2 rounded-full text-sm font-semibold 
                        ${cat === activeCategory ? 'bg-blue-800 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}">
                    ${cat === 'all' ? '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' : cat}
                </button>
            `).join('');
        }
        
        window.filterProducts = (category) => {
            activeCategory = category;
            const filtered = category === 'all' 
                ? allProducts 
                : allProducts.filter(p => p.category === category);
            renderProductList(filtered);
            renderCategoryFilters(allProducts); 
        };

        function renderProductList(products) {
            const list = document.getElementById('product-list');
            list.innerHTML = products.map(product => `
                <div onclick="addToCart('${product.id}')" 
                    class="card-bg p-4 rounded-lg shadow-md hover:shadow-xl transition duration-200 cursor-pointer border border-gray-100 flex flex-col">
                    <img src="${product.imageUrl || 'https://via.placeholder.com/150x100.png?text=No+Image'}" 
                        alt="${product.name}" class="w-full h-24 object-cover rounded-md mb-2">
                    <h4 class="font-bold text-gray-800 flex-grow">${product.name}</h4>
                    <p class="text-sm text-gray-500">${product.category}</p>
                    <p class="text-lg font-extrabold text-green-600 mt-1">${product.price.toFixed(2)} ‡∏ø</p>
                </div>
            `).join('');
        }

        // Admin Product Management
        document.getElementById('menu-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (userRole !== 'admin') {
                showCustomError("‚ùå ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Admin ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ");
                return;
            }
            
            const id = document.getElementById('product-id').value;
            const name = document.getElementById('product-name').value.trim();
            const price = parseFloat(document.getElementById('product-price').value);
            const category = document.getElementById('product-category').value.trim();
            const imageUrl = document.getElementById('product-image-url').value.trim();
            
            if (isNaN(price) || price < 0) {
                showCustomError("‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏õ‡πâ‡∏≠‡∏ô‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
                return;
            }

            const productData = { name, price, category, imageUrl };

            try {
                if (id) {
                    await updateDoc(doc(db, "products", id), productData);
                    showCustomError(`‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ "${name}" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, false);
                } else {
                    await addDoc(collection(db, "products"), productData);
                    showCustomError(`‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà "${name}" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, false);
                }
                resetMenuForm();
                fetchProducts();
                renderAdminProductList();
            } catch (error) {
                showCustomError("‚ùå Error saving product: " + error.message);
            }
        });

        window.editProduct = (id, name, price, category, imageUrl) => {
            document.getElementById('product-id').value = id;
            document.getElementById('product-name').value = name;
            document.getElementById('product-price').value = price;
            document.getElementById('product-category').value = category;
            document.getElementById('product-image-url').value = imageUrl;
            document.getElementById('menu-submit-btn').textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç';
            showCustomError(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: ${name}`, false);
        };

        window.resetMenuForm = () => {
            document.getElementById('product-id').value = '';
            document.getElementById('product-name').value = '';
            document.getElementById('product-price').value = '';
            document.getElementById('product-category').value = '';
            document.getElementById('product-image-url').value = '';
            document.getElementById('menu-submit-btn').textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà';
        };

        window.deleteProduct = async (id, name) => {
            if (userRole !== 'admin') {
                showCustomError("‚ùå ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Admin ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ");
                return;
            }
            if (confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ "${name}" ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
                try {
                    await deleteDoc(doc(db, "products", id));
                    showCustomError(`‚úÖ ‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ "${name}" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, false);
                    fetchProducts();
                    renderAdminProductList();
                } catch (error) {
                    showCustomError("‚ùå Error deleting product: " + error.message);
                }
            }
        };

        async function renderAdminProductList() {
            const productsCol = collection(db, 'products');
            const productSnapshot = await getDocs(productsCol);
            const products = productSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            const listBody = document.getElementById('admin-product-list');
            listBody.innerHTML = products.map(p => `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${p.name} (${p.category})</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">${p.price.toFixed(2)} ‡∏ø</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <img src="${p.imageUrl || 'https://via.placeholder.com/50x30.png?text=N/A'}" class="h-8 w-8 object-cover rounded" alt="Product Image">
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="editProduct('${p.id}', '${p.name}', ${p.price}, '${p.category}', '${p.imageUrl}')" 
                                class="text-indigo-600 hover:text-indigo-900 mx-1">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                        <button onclick="deleteProduct('${p.id}', '${p.name}')" 
                                class="text-red-600 hover:text-red-900 mx-1">‡∏•‡∏ö</button>
                    </td>
                </tr>
            `).join('');
        }


        // ----------------------------------------------------
        // 6. Cart Logic
        // ----------------------------------------------------
        
        window.addToCart = (productId) => {
            const product = allProducts.find(p => p.id === productId);
            if (!product) {
                showCustomError("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ");
                return;
            }
            
            const existingItem = cart.find(item => item.id === productId);
            
            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                cart.push({
                    id: product.id,
                    name: product.name,
                    price: product.price,
                    quantity: 1
                });
            }
            showCustomError(`‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° ${product.name} ‡∏•‡∏á‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤`, false);
            renderCart();
        };

        window.updateQuantity = (productId, change) => {
            const index = cart.findIndex(item => item.id === productId);
            if (index > -1) {
                cart[index].quantity += change;
                if (cart[index].quantity <= 0) {
                    cart.splice(index, 1); // Remove if quantity is zero or less
                }
            }
            renderCart();
            updatePaymentModalSummary(); // Important to update total immediately
        };
        
        const calculateCartTotal = function() {
            const subtotal = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);

            // Apply code discount (Max reduction is subtotal)
            let codeDiscount = discountCodeValue;
            if (subtotal - codeDiscount < 0) {
                codeDiscount = subtotal;
            }
            let currentTotal = subtotal - codeDiscount;

            // Apply points redemption (Max reduction is remaining total)
            // Redemption: 100 points = 1 THB
            const pointsToRedeem = redemptionAmount * 100; 
            let redeemDiscount = redemptionAmount;
            if (currentTotal - redeemDiscount < 0) {
                redeemDiscount = currentTotal > 0 ? currentTotal : 0;
            }
            const finalTotal = currentTotal - redeemDiscount;

            return {
                subtotal,
                code_discount: codeDiscount,
                redeem_discount: redeemDiscount,
                points_redeemed: pointsToRedeem,
                total: finalTotal
            };
        };

        window.renderCart = () => {
            const list = document.getElementById('cart-list');
            const summary = document.getElementById('cart-summary');
            const checkoutBtn = document.getElementById('checkout-btn');

            if (cart.length === 0) {
                list.innerHTML = '<p class="text-gray-500">‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤</p>';
                summary.innerHTML = '‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: <span class="text-blue-600">0.00</span> ‡∏ö‡∏≤‡∏ó';
                checkoutBtn.disabled = true;
                return;
            }

            const totalComponents = calculateCartTotal();
            const finalTotal = totalComponents.total;

            list.innerHTML = cart.map(item => `
                <div class="flex justify-between items-center p-2 bg-white rounded-lg shadow-sm">
                    <div class="flex-grow">
                        <p class="font-semibold text-sm">${item.name}</p>
                        <p class="text-xs text-gray-500">${item.price.toFixed(2)} ‡∏ø</p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button onclick="updateQuantity('${item.id}', -1)" class="text-red-500 hover:text-red-700 font-bold text-lg">-</button>
                        <span class="text-md font-bold w-6 text-center">${item.quantity}</span>
                        <button onclick="updateQuantity('${item.id}', 1)" class="text-green-500 hover:text-green-700 font-bold text-lg">+</button>
                    </div>
                    <p class="font-bold text-right w-16">${(item.price * item.quantity).toFixed(2)}</p>
                </div>
            `).join('');

            let summaryHTML = `‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° (‡∏Å‡πà‡∏≠‡∏ô‡∏•‡∏î): <span>${totalComponents.subtotal.toFixed(2)}</span> ‡∏ö‡∏≤‡∏ó`;
            
            if (totalComponents.code_discount > 0) {
                summaryHTML += `<br>‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡πÇ‡∏Ñ‡πâ‡∏î: <span class="text-red-500">- ${totalComponents.code_discount.toFixed(2)}</span> ‡∏ö‡∏≤‡∏ó`;
            }
            if (totalComponents.redeem_discount > 0) {
                summaryHTML += `<br>‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡πÅ‡∏ï‡πâ‡∏°: <span class="text-red-500">- ${totalComponents.redeem_discount.toFixed(2)}</span> ‡∏ö‡∏≤‡∏ó`;
            }

            summary.innerHTML = `
                <p class="text-base text-gray-600 font-normal text-right">${summaryHTML}</p>
                <p class="mt-2">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥: <span class="text-blue-600">${finalTotal.toFixed(2)}</span> ‡∏ö‡∏≤‡∏ó</p>
            `;
            
            checkoutBtn.disabled = finalTotal <= 0;
        };

        // ----------------------------------------------------
        // 7. Loyalty & Discount Logic
        // ----------------------------------------------------
        
        window.findCustomer = async function() {
            const phone = document.getElementById('loyalty-phone-input').value.trim();
            const firstName = document.getElementById('loyalty-first-name-input').value.trim();
            const lastName = document.getElementById('loyalty-last-name-input').value.trim();
            const infoDiv = document.getElementById('customer-info');
            infoDiv.innerHTML = '<p class="text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...</p>';
            currentCustomer = null;
            redemptionAmount = 0;
            document.getElementById('loyalty-redeem-section').classList.add('hidden');
            document.getElementById('redeem-info').textContent = '';

            if (phone.length === 0) {
                infoDiv.innerHTML = `<p class="text-red-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</p>`;
                renderCart();
                return;
            }

            try {
                const customersCol = collection(db, 'customers');
                const q = query(customersCol, where('phone', '==', phone), limit(1));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    const fullName = (firstName + ' ' + lastName).trim();
                    if (!firstName || !lastName) {
                        infoDiv.innerHTML = `<p class="text-orange-600">‚ö† ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤. ‡∏Å‡∏£‡∏≠‡∏Å ‡∏ä‡∏∑‡πà‡∏≠ ‡πÅ‡∏•‡∏∞ ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</p>`;
                        return;
                    }
                    
                    // Create new customer
                    const newCustomerRef = await addDoc(collection(db, "customers"), {
                        phone: phone,
                        firstName: firstName,
                        lastName: lastName,
                        points: 0,
                        registered_at: serverTimestamp()
                    });

                    currentCustomer = { id: newCustomerRef.id, phone, firstName, lastName, points: 0 };
                    showCustomError(`‚úÖ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà: ${fullName}`, false);

                } else {
                    // Found existing customer
                    const docSnap = querySnapshot.docs[0];
                    currentCustomer = { id: docSnap.id, ...docSnap.data() };
                    showCustomError(`‚úÖ ‡∏û‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å: ${currentCustomer.firstName}`, false);
                }

                // Update UI for found customer
                infoDiv.innerHTML = `
                    <p class="font-bold text-blue-700">${currentCustomer.firstName} ${currentCustomer.lastName}</p>
                    <p class="text-sm">üìû ${currentCustomer.phone}</p>
                    <p class="text-sm font-semibold text-yellow-800">‚≠ê ‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏∞‡∏™‡∏°: ${currentCustomer.points.toLocaleString()}</p>
                `;
                document.getElementById('loyalty-redeem-section').classList.remove('hidden');

            } catch (error) {
                showCustomError("‚ùå Error finding customer: " + error.message);
            }
            renderCart();
        };

        window.redeemPoints = function() {
            if (!currentCustomer) return;

            const redeemInput = document.getElementById('redeem-points-input');
            const redeemPoints = parseInt(redeemInput.value);
            const redeemInfo = document.getElementById('redeem-info');

            if (isNaN(redeemPoints) || redeemPoints < 0) {
                redeemInfo.textContent = '‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏õ‡πâ‡∏≠‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ï‡πâ‡∏°‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
                redeemInfo.classList.add('text-red-600');
                return;
            }

            if (redeemPoints > currentCustomer.points) {
                redeemInfo.textContent = `‚ùå ‡πÅ‡∏ï‡πâ‡∏°‡πÑ‡∏°‡πà‡∏û‡∏≠! ‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ ${currentCustomer.points.toLocaleString()} ‡πÅ‡∏ï‡πâ‡∏°`;
                redeemInfo.classList.add('text-red-600');
                redemptionAmount = 0;
                renderCart();
                return;
            }

            // Redemption: 100 points = 1 THB
            const amount = redeemPoints / 100;
            redemptionAmount = amount;
            
            redeemInfo.textContent = `‚úÖ ‡πÅ‡∏•‡∏Å ${redeemPoints.toLocaleString()} ‡πÅ‡∏ï‡πâ‡∏° = ${amount.toFixed(2)} ‡∏ö‡∏≤‡∏ó`;
            redeemInfo.classList.remove('text-red-600');
            redeemInfo.classList.add('text-green-600');
            
            updatePaymentModalSummary();
            renderCart();
        };

        // UPDATED: Discount Code Logic
        window.applyDiscountCode = function() {
            const code = document.getElementById('discount-code-input').value.trim();
            const discountInfo = document.getElementById('discount-code-info');
            discountCodeValue = 0; 
            discountInfo.textContent = '';
            
            if (code === 'COFFEE20') {
                discountCodeValue = 20; // 20 THB discount
                discountInfo.textContent = `‚úÖ ‡πÉ‡∏ä‡πâ‡πÇ‡∏Ñ‡πâ‡∏î "${code}" ‡∏•‡∏î 20.00 ‡∏ö‡∏≤‡∏ó`;
                discountInfo.classList.remove('text-red-600');
                discountInfo.classList.add('text-green-600');
            } else if (code === '1free1') {
                discountCodeValue = 45; // 45 THB discount
                discountInfo.textContent = `‚úÖ ‡πÉ‡∏ä‡πâ‡πÇ‡∏Ñ‡πâ‡∏î "${code}" ‡∏•‡∏î 45.00 ‡∏ö‡∏≤‡∏ó`;
                discountInfo.classList.remove('text-red-600');
                discountInfo.classList.add('text-green-600');
            
            } else if (code.length > 0) {
                discountInfo.textContent = `‚ùå ‡πÇ‡∏Ñ‡πâ‡∏î "${code}" ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á`;
                discountCodeValue = 0; // Ensure reset
                discountInfo.classList.add('text-red-600');
            }
            updatePaymentModalSummary();
            renderCart();
        };

        // ----------------------------------------------------
        // 8. Payment & Checkout Logic
        // ----------------------------------------------------

        window.calculateChange = function() {
            const totalComponents = calculateCartTotal();
            const total = totalComponents.total;
            const receivedInput = document.getElementById('cash-received-input');
            const changeSpan = document.getElementById('change-info').querySelector('span');
            const cashButton = document.querySelector('#payment-options button[onclick="simulatePayment(\'Cash\')"]');

            const received = parseFloat(receivedInput.value) || 0;
            const change = Math.max(0, received - total);

            if (received >= total && total > 0) {
                if (cashButton) cashButton.disabled = false;
            } else { // Cash received < total or total is 0
                if (cashButton) cashButton.disabled = true;
            }
            changeSpan.textContent = change.toFixed(2);
        };

        function updatePaymentModalSummary() {
            const totalComponents = calculateCartTotal();
            const finalTotal = totalComponents.total;
            document.getElementById('payment-summary').innerHTML = `‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∞: <span class="text-red-600 font-extrabold">${finalTotal.toFixed(2)}</span> ‡∏ö‡∏≤‡∏ó`;

            // NEW: ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å calculateChange ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î
            calculateChange(); 

            if (currentCustomer) {
                document.getElementById('current-points-info').innerHTML = `‡∏°‡∏µ‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏∞‡∏™‡∏°: <span class="font-bold">${currentCustomer.points.toLocaleString()}</span> ‡πÅ‡∏ï‡πâ‡∏°`;
            }

            // Reset redemption info if points or code changed
            if (totalComponents.redeem_discount === 0 && redemptionAmount > 0) {
                document.getElementById('redeem-info').textContent = '‡πÅ‡∏ï‡πâ‡∏°‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏Å‡∏ñ‡∏π‡∏Å‡∏•‡∏î‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏¢‡∏≠‡∏î‡πÑ‡∏°‡πà‡∏û‡∏≠';
                document.getElementById('redeem-info').classList.add('text-red-600');
            } else if (redemptionAmount > 0) {
                document.getElementById('redeem-info').textContent = `‚úÖ ‡πÅ‡∏•‡∏Å ${totalComponents.points_redeemed.toLocaleString()} ‡πÅ‡∏ï‡πâ‡∏° = ${totalComponents.redeem_discount.toFixed(2)} ‡∏ö‡∏≤‡∏ó`;
            }

            if (totalComponents.code_discount === 0 && discountCodeValue > 0) {
                document.getElementById('discount-code-info').textContent = '‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏ñ‡∏π‡∏Å‡∏à‡∏≥‡∏Å‡∏±‡∏î‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏¢‡∏≠‡∏î‡πÑ‡∏°‡πà‡∏û‡∏≠';
                document.getElementById('discount-code-info').classList.add('text-red-600');
            } else if (discountCodeValue > 0) {
                document.getElementById('discount-code-info').textContent = `‚úÖ ‡πÇ‡∏Ñ‡πâ‡∏î‡∏•‡∏î ${totalComponents.code_discount.toFixed(2)} ‡∏ö‡∏≤‡∏ó`;
            }
        }

        // UPDATED openPaymentModal
        window.openPaymentModal = () => {
            if (cart.length === 0) return;
            document.getElementById('payment-modal').classList.remove('hidden');

            // Reset modal fields on open
            document.getElementById('redeem-points-input').value = '';
            document.getElementById('discount-code-input').value = '';
            document.getElementById('discount-code-info').textContent = '';

            // NEW Reset Change Fields
            const cashButton = document.querySelector('#payment-options button[onclick="simulatePayment(\'Cash\')"]');
            document.getElementById('cash-received-input').value = '';
            document.getElementById('change-info').querySelector('span').textContent = '0.00';
            if (cashButton) cashButton.disabled = true; // Disable Cash button initially

            discountCodeValue = 0;
            redemptionAmount = 0;
            updatePaymentModalSummary();
        };

        // UPDATED simulatePayment
        window.simulatePayment = async function(method) {
            const totalComponents = calculateCartTotal();
            const finalTotal = totalComponents.total;
            const cashReceivedInput = document.getElementById('cash-received-input');
            let cash_received = null;
            let change_given = null;

            if (finalTotal <= 0) {
                 showCustomError("‚ùå ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô 0.00 ‡∏ö‡∏≤‡∏ó ‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô", true);
                 return;
            }
            
            if (method === 'Cash') {
                cash_received = parseFloat(cashReceivedInput.value);
                if (isNaN(cash_received) || cash_received < finalTotal) {
                    showCustomError("‚ùå ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÑ‡∏°‡πà‡∏û‡∏≠", true);
                    return;
                }
                change_given = cash_received - finalTotal;
            }

            // NEW: Get the current time for immediate receipt display
            const currentReceiptTime = new Date().toLocaleString('th-TH');

            // 1. Prepare Order Object
            // *** ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ: 1 ‡∏ö‡∏≤‡∏ó (‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥) = 1 ‡πÅ‡∏ï‡πâ‡∏° (‡∏õ‡∏±‡∏î‡∏•‡∏á) ***
            const pointsEarned = currentCustomer ? Math.floor(finalTotal) : 0; 
            const pointsRedeemed = totalComponents.points_redeemed;

            const newOrder = {
                items: cart,
                subtotal_amount: totalComponents.subtotal,
                code_discount: totalComponents.code_discount,
                redeem_discount: totalComponents.redeem_discount,
                total_amount: finalTotal,
                payment_method: method,
                cash_received: cash_received, 
                change_given: change_given,   
                customer_uid: currentCustomer ? currentCustomer.id : null,
                customer_phone: currentCustomer ? currentCustomer.phone : 'Guest',
                customer_name: currentCustomer && currentCustomer.firstName && currentCustomer.lastName ? `${currentCustomer.firstName} ${currentCustomer.lastName}` : 'Guest',
                points_earned: pointsEarned,
                points_redeemed: pointsRedeemed,
                staff_uid: currentUserId,
                staff_name: staffName,
                timestamp: serverTimestamp(),
                receipt_datetime: currentReceiptTime,
            };

            let customerBeforePoints = null;

            // 2. Calculate and Update Loyalty Points
            if (currentCustomer) {
                customerBeforePoints = currentCustomer.points;
                const newPoints = currentCustomer.points - pointsRedeemed + pointsEarned;
                try {
                    await updateDoc(doc(db, "customers", currentCustomer.id), {
                        points: newPoints
                    });
                    currentCustomer.points = newPoints;
                } catch (error) {
                    showCustomError("‚ùå Error updating loyalty points: " + error.message);
                }
            }

            // 3. Save Order to Firestore
            try {
                const orderRef = await addDoc(collection(db, "orders"), newOrder);
                newOrder.id = orderRef.id;
            } catch (error) {
                showCustomError("‚ùå Error saving order: " + error.message);
            }
            
            // 4. Show Receipt Modal
            showReceiptModal(newOrder, customerBeforePoints);

            // 5. Reset POS
            cart = [];
            redemptionAmount = 0;
            discountCodeValue = 0;
            currentCustomer = null; // IMPORTANT: Reset customer
            document.getElementById('loyalty-phone-input').value = '';
            document.getElementById('loyalty-first-name-input').value = '';
            document.getElementById('loyalty-last-name-input').value = '';
            document.getElementById('customer-info').innerHTML = `<p class="text-red-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</p>`;
            document.getElementById('loyalty-redeem-section').classList.add('hidden');
            document.getElementById('payment-modal').classList.add('hidden');
            renderCart();
            
            // 6. Update Reports
            if (userRole === 'admin') {
                renderSalesReport('daily');
                renderOrderHistory(true); // Re-fetch and cache new orders
            }
        };

        // UPDATED showReceiptModal
        window.showReceiptModal = function(order, customerBeforePoints) {
            const modal = document.getElementById('receipt-modal');
            const details = document.getElementById('receipt-details');
            const itemsList = document.getElementById('receipt-items');
            const summary = document.getElementById('receipt-summary');
            
            // Use receipt_datetime if available (from current payment), or convert timestamp for old orders
            let dateTimeToDisplay = 'N/A';
            if (order.receipt_datetime) {
                dateTimeToDisplay = order.receipt_datetime;
            } else if (order.timestamp && order.timestamp.toDate) {
                try {
                    dateTimeToDisplay = order.timestamp.toDate().toLocaleString('th-TH');
                } catch (e) { /* ignore */ }
            }
            
            details.innerHTML = `
                <div class="flex justify-between"><span>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô:</span><span>${order.staff_name}</span></div>
                <div class="flex justify-between"><span>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤:</span><span>${dateTimeToDisplay}</span></div>
                <div class="flex justify-between"><span>‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå ID:</span><span>${order.id || 'N/A'}</span></div>
                <div class="flex justify-between"><span>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:</span><span>${order.customer_name} (${order.customer_phone})</span></div>
            `;

            itemsList.innerHTML = order.items.map(item => `
                <div class="flex justify-between text-gray-800">
                    <span class="w-1/2">${item.name}</span>
                    <span class="w-1/4 text-center">${item.quantity} x ${item.price.toFixed(2)}</span>
                    <span class="w-1/4 text-right">${(item.price * item.quantity).toFixed(2)}</span>
                </div>
            `).join('');

            let loyaltySummary = '';
            // Only show loyalty summary if we have some point data (earned/redeemed > 0 or customerBeforePoints is passed)
            if (order.points_earned > 0 || order.points_redeemed > 0) {
                 // The accuracy of 'Points Before' for old transactions requires storing it explicitly during the transaction.
                
                let pointsAfter = 'N/A';
                if (customerBeforePoints >= 0) { // Only show this calculation for live transaction or when a starting point is provided
                    pointsAfter = (customerBeforePoints - order.points_redeemed + order.points_earned).toLocaleString();
                }

                loyaltySummary = `
                    <div class="flex justify-between text-xs text-red-600 pt-1 border-t mt-2"><span>‡πÅ‡∏•‡∏Å‡πÅ‡∏ï‡πâ‡∏°:</span><span class="font-bold">-${order.points_redeemed.toLocaleString()}</span></div>
                    <div class="flex justify-between text-xs text-green-600"><span>‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πâ‡∏°:</span><span class="font-bold">+${order.points_earned.toLocaleString()}</span></div>
                    ${pointsAfter !== 'N/A' ? `<div class="flex justify-between text-sm font-bold mt-1 text-yellow-800 border-t pt-1"><span>‡πÅ‡∏ï‡πâ‡∏°‡πÉ‡∏´‡∏°‡πà:</span><span>${pointsAfter}</span></div>` : ''}
                `;
            }

            summary.innerHTML = `
                <div class="flex justify-between text-sm"><span>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏•‡∏î:</span><span>${order.subtotal_amount.toFixed(2)}</span></div>
                ${order.code_discount > 0 ? `<div class="flex justify-between text-sm text-red-600"><span>‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡πÇ‡∏Ñ‡πâ‡∏î:</span><span>-${order.code_discount.toFixed(2)}</span></div>` : ''}
                ${order.redeem_discount > 0 ? `<div class="flex justify-between text-sm text-red-600"><span>‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡πÅ‡∏ï‡πâ‡∏°:</span><span>-${order.redeem_discount.toFixed(2)}</span></div>` : ''}
                <div class="flex justify-between text-lg font-bold border-t mt-2 pt-2">
                    <span>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥:</span><span>${order.total_amount.toFixed(2)} ‡∏ö‡∏≤‡∏ó</span>
                </div>
                <div class="text-sm mt-3">
                    <div class="flex justify-between"><span>‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞:</span><span>${order.payment_method}</span></div>
                    ${order.cash_received !== null && order.cash_received !== undefined ? `<div class="flex justify-between"><span>‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î:</span><span>${order.cash_received.toFixed(2)}</span></div>` : ''}
                    ${order.change_given !== null && order.change_given !== undefined ? `<div class="flex justify-between"><span>‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏≠‡∏ô:</span><span class="font-bold text-green-600">${order.change_given.toFixed(2)}</span></div>` : ''}
                </div>
                ${loyaltySummary}
            `;

            modal.classList.remove('hidden');
            document.getElementById('payment-modal').classList.add('hidden');
        }


        // ----------------------------------------------------
        // 9. Admin & Report Logic
        // ----------------------------------------------------
        
        // NEW: Function to fetch all orders
        async function fetchOrders() {
            const ordersCol = collection(db, 'orders');
            // Query to fetch orders sorted by timestamp in descending order
            const q = query(ordersCol, orderBy('timestamp', 'desc'));
            const orderSnapshot = await getDocs(q);
            return orderSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        }

        // UPDATED: renderSalesReport with Period Filter and Export Fix
        window.renderSalesReport = async (period = 'daily') => {
            // 1. Update active button style
            document.querySelectorAll('#admin-tab-sales button[id^="filter-"]').forEach(btn => {
                btn.classList.remove('bg-blue-100', 'hover:bg-blue-200', 'text-blue-800');
                btn.classList.add('bg-gray-200', 'hover:bg-gray-300', 'text-gray-700');
            });
            const activeBtn = document.getElementById(`filter-${period}`);
            if (activeBtn) {
                activeBtn.classList.remove('bg-gray-200', 'hover:bg-gray-300', 'text-gray-700');
                activeBtn.classList.add('bg-blue-100', 'hover:bg-blue-200', 'text-blue-800');
            }

            // 2. Get date range and create query
            const { startDate, endDate } = getDateRange(period);
            const ordersCol = collection(db, 'orders');
            
            // NOTE: Firestore requires the first orderBy to match the 'where' field if using range queries
            const q = query(ordersCol, 
                where('timestamp', '>=', startDate),
                where('timestamp', '<=', endDate),
                orderBy('timestamp', 'desc')
            );
            
            try {
                const orderSnapshot = await getDocs(q);
                // **IMPORTANT: Must get ID with data for export function**
                const orders = orderSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // **FIX FOR EXPORT:** Store filtered orders globally
                currentFilteredOrders = orders;

                let totalSales = 0;
                const productSales = {};
                let uniqueCustomers = new Set();
                let totalOrders = 0;

                orders.forEach(order => {
                    totalSales += order.total_amount;
                    totalOrders += 1;

                    // Track product sales
                    order.items.forEach(item => {
                        const productName = item.name;
                        // For reporting, use subtotal before discounts for product ranking
                        productSales[productName] = (productSales[productName] || 0) + item.price * item.quantity;
                    });

                    // Track unique customers
                    if (order.customer_phone && order.customer_phone !== 'Guest') {
                        uniqueCustomers.add(order.customer_phone);
                    }
                });

                document.getElementById('report-total-sales').textContent = totalSales.toFixed(2) + ' ‡∏ø';
                document.getElementById('report-total-orders').textContent = totalOrders.toLocaleString() + ' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£';
                document.getElementById('report-total-customers').textContent = uniqueCustomers.size.toLocaleString() + ' ‡∏Ñ‡∏ô';

                // Chart Logic (Top 5 Products)
                const sortedProducts = Object.entries(productSales)
                    .sort(([, a], [, b]) => b - a)
                    .slice(0, 5);

                const productNames = sortedProducts.map(([name]) => name);
                const productAmounts = sortedProducts.map(([, amount]) => amount);

                if (myChart) {
                    myChart.destroy();
                }

                const ctx = document.getElementById('salesChart').getContext('2d');
                myChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: productNames,
                        datasets: [{
                            label: '‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ (‡∏ö‡∏≤‡∏ó)',
                            data: productAmounts,
                            backgroundColor: [
                                'rgba(255, 99, 132, 0.7)',
                                'rgba(54, 162, 235, 0.7)',
                                'rgba(255, 206, 86, 0.7)',
                                'rgba(75, 192, 192, 0.7)',
                                'rgba(153, 102, 255, 0.7)',
                            ],
                            borderColor: [
                                'rgba(255, 99, 132, 1)',
                                'rgba(54, 162, 235, 1)',
                                'rgba(255, 206, 86, 1)',
                                'rgba(75, 192, 192, 1)',
                                'rgba(153, 102, 255, 1)',
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: `‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏î‡∏µ 5 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡πÅ‡∏£‡∏Å (‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô: ${period.toUpperCase()})`
                            }
                        }
                    }
                });
            } catch (error) {
                showCustomError(`‚ùå Error fetching sales report: ${error.message}`, true);
            }
        }

        // **FIXED:** Order History Functions
        window.renderOrderHistory = async (forceRefetch = false) => {
            if (userRole !== 'admin') return; // ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡πÉ‡∏´‡πâ Admin ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏î‡πâ

            if (allOrdersCache.length === 0 || forceRefetch) {
                try {
                    allOrdersCache = await fetchOrders(); 
                } catch (error) {
                    showCustomError("‚ùå Error fetching order history: " + error.message, true);
                    return;
                }
            }
            filterOrderHistory(); 
        };

        window.filterOrderHistory = () => {
            const listBody = document.getElementById('order-history-list');
            const searchTerm = document.getElementById('order-search-input').value.toLowerCase().trim();

            const filteredOrders = allOrdersCache.filter(order => {
                if (!searchTerm) return true;
                
                // Check ID, customer name/phone, and staff name
                const orderId = order.id || '';
                const matchID = orderId.toLowerCase().includes(searchTerm);
                const matchCustomer = order.customer_name.toLowerCase().includes(searchTerm) || 
                                      (order.customer_phone || '').toLowerCase().includes(searchTerm);
                const matchStaff = order.staff_name.toLowerCase().includes(searchTerm);
                
                return matchID || matchCustomer || matchStaff;
            });

            listBody.innerHTML = filteredOrders.map(order => {
                let dateTimeDisplay = 'N/A';
                if (order.receipt_datetime) {
                    dateTimeDisplay = order.receipt_datetime;
                } else if (order.timestamp && order.timestamp.toDate) {
                    try {
                        dateTimeDisplay = order.timestamp.toDate().toLocaleString('th-TH');
                    } catch (e) { /* ignore */ }
                }
                
                const orderIdShort = order.id ? order.id.substring(0, 8) + '...' : 'N/A';

                return `
                    <tr class="hover:bg-gray-100">
                        <td class="px-3 py-2 whitespace-nowrap text-xs font-mono">${orderIdShort}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-sm">${dateTimeDisplay}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-sm">${order.customer_name} (${order.customer_phone})</td>
                        <td class="px-3 py-2 whitespace-nowrap text-sm">${order.staff_name}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-right font-bold text-green-700">${order.total_amount.toFixed(2)} ‡∏ø</td>
                        <td class="px-3 py-2 whitespace-nowrap text-center">
                            <button onclick="viewOrderDetails('${order.id}')" class="text-blue-600 hover:text-blue-800 text-xs">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button>
                        </td>
                    </tr>
                `;
            }).join('');
        };

        window.viewOrderDetails = (orderId) => {
            const order = allOrdersCache.find(o => o.id === orderId);
            if (!order) {
                showCustomError('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠', true);
                return;
            }
            // Passing 0 for points before, as the exact value for old orders is not stored in the structure
            showReceiptModal(order, 0); 
        };

        // **FIXED & IMPROVED:** Export Sales Data with BOM and detailed accounting fields
        window.exportSalesDataToCSV = function() {
            // ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏î‡∏∂‡∏á‡∏°‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å renderSalesReport (currentFilteredOrders)
            const ordersForExport = currentFilteredOrders; 
            
            if (ordersForExport.length === 0) {
                showCustomError("‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å", true);
                return;
            }

            // Headers for CSV (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ)
            const headers = [
                'ID ‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤', '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô', '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡πÇ‡∏ó‡∏£)', 
                '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', '‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏•‡∏î', '‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡πÅ‡∏•‡∏Å‡πÅ‡∏ï‡πâ‡∏°', '‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡πÇ‡∏Ñ‡πâ‡∏î', 
                '‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥', '‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞', '‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö', '‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏≠‡∏ô', '‡πÅ‡∏ï‡πâ‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö'
            ]; 
            let csv = headers.map(h => `"${h}"`).join(',') + '\n'; // ‡πÉ‡∏™‡πà‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏Ñ‡∏≥‡∏û‡∏π‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ú‡∏¥‡∏î‡πÄ‡∏û‡∏µ‡πâ‡∏¢‡∏ô

            ordersForExport.forEach(order => {
                // 1. Prepare Date/Time
                let dateTimeDisplay = 'N/A';
                if (order.receipt_datetime) {
                    dateTimeDisplay = order.receipt_datetime;
                } else if (order.timestamp && order.timestamp.toDate) {
                    try {
                        dateTimeDisplay = order.timestamp.toDate().toLocaleString('th-TH');
                    } catch (e) { /* ignore */ }
                }

                // 2. Summarize Items for one cell (Accounting Friendly format)
                // Format: '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ A (x2) @ 50.00 | ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ B (x1) @ 100.00'
                const itemSummary = order.items.map(item => 
                    `${item.name} (x${item.quantity}) @ ${item.price.toFixed(2)}`
                ).join(' | ');

                // 3. Prepare row values
                const rowData = [
                    order.id || 'N/A',
                    dateTimeDisplay,
                    order.staff_name || 'N/A',
                    `${order.customer_name || 'Walk-in'} (${order.customer_phone || 'N/A'})`,
                    itemSummary, // ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå
                    (order.subtotal_amount || 0).toFixed(2),
                    (order.redeem_discount || 0).toFixed(2),
                    (order.code_discount || 0).toFixed(2),
                    (order.total_amount || 0).toFixed(2),
                    order.payment_method || 'N/A',
                    (order.cash_received !== null && order.cash_received !== undefined ? order.cash_received : 0).toFixed(2),
                    (order.change_given !== null && order.change_given !== undefined ? order.change_given : 0).toFixed(2),
                    (order.points_earned || 0).toLocaleString()
                ];
                
                // 4. Format row for CSV (‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏±‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏à‡∏∏‡∏•‡∏†‡∏≤‡∏Ñ‡πÅ‡∏•‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏Ñ‡∏≥‡∏û‡∏π‡∏î‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)
                const row = rowData.map(value => {
                    // Replace double quotes with escaped double quotes
                    let stringValue = String(value).replace(/"/g, '""');
                    // Enclose in double quotes if it contains commas, newlines, or double quotes
                    if (stringValue.includes(',') || stringValue.includes('\n') || stringValue.includes('"')) {
                        stringValue = `"${stringValue}"`;
                    }
                    return stringValue;
                }).join(',');

                csv += row + '\n';
            });

            // 5. Trigger Download
            const periodName = document.querySelector('#admin-tab-sales button.bg-blue-100')?.textContent.trim() || '‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
            const filename = `Sales_Report_${periodName}_${new Date().toISOString().slice(0, 10)}.csv`;
            
            // ‡πÄ‡∏û‡∏¥‡πà‡∏° BOM (Byte Order Mark) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Excel ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
            const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csv], { type: 'text/csv;charset=utf-8;' }); 
            const link = document.createElement("a");

            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showCustomError(`‚úÖ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${ordersForExport.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, false);
            } else {
                showCustomError("‚ùå ‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥", true);
            }
        };


        async function renderAdminUserList() {
            if (userRole !== 'admin') return;
            const usersCol = collection(db, 'users');
            const userSnapshot = await getDocs(usersCol);
            const users = userSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            const listDiv = document.getElementById('admin-user-list');
            listDiv.innerHTML = users.map(u => `
                <div class="flex justify-between items-center p-3 border rounded-lg shadow-sm ${u.role === 'admin' ? 'bg-blue-50' : 'bg-gray-50'}">
                    <div class="flex-grow">
                        <p class="font-bold text-gray-800">${u.name} ${u.id === currentUserId ? '(‡∏Ñ‡∏∏‡∏ì)' : ''}</p>
                        <p class="text-sm text-gray-600">${u.email}</p>
                    </div>
                    <div class="flex items-center space-x-3">
                        <span class="font-extrabold p-1 rounded ${u.role === 'admin' ? 'text-red-600' : 'text-green-600'}">
                            ${u.role.toUpperCase()}
                        </span>
                        
                        <button onclick="promptAndSaveName('${u.id}', '${u.name}')" class="text-indigo-600 hover:text-indigo-800 text-sm">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠</button>

                        ${u.id !== currentUserId ? 
                            `<select onchange="updateUserRole('${u.id}', this.value, '${u.name}')" class="p-1 border rounded text-sm bg-white">
                                <option value="staff" ${u.role === 'staff' ? 'selected' : ''}>Staff</option>
                                <option value="admin" ${u.role === 'admin' ? 'selected' : ''}>Admin</option>
                            </select>` 
                            : ''
                        }
                    </div>
                </div>
            `).join('');
        }

        window.promptAndSaveName = async (userId, oldName) => {
            if (userRole !== 'admin') {
                showCustomError("‚ùå ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Admin ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÑ‡∏î‡πâ");
                return;
            }
            const newName = prompt(`‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö: ${oldName}`, oldName);
            if (newName && newName.trim() !== oldName) {
                try {
                    await updateDoc(doc(db, "users", userId), {
                        name: newName.trim()
                    });
                    showCustomError(`‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô "${newName.trim()}" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, false);
                    
                    if (userId === currentUserId) {
                        staffName = newName.trim();
                        document.getElementById('user-info').textContent = `${staffName} (${userRole})`;
                    }
                    renderAdminUserList();
                } catch (error) {
                    showCustomError("‚ùå Error updating user name: " + error.message);
                }
            }
        };

        window.updateUserRole = async (userId, newRole, name) => {
            if (userRole !== 'admin' || userId === currentUserId) {
                showCustomError("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡πÑ‡∏î‡πâ ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå");
                return;
            }
            if (confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏Ç‡∏≠‡∏á ${name} ‡πÄ‡∏õ‡πá‡∏ô ${newRole.toUpperCase()} ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
                try {
                    await updateDoc(doc(db, "users", userId), {
                        role: newRole
                    });
                    showCustomError(`‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏Ç‡∏≠‡∏á ${name} ‡πÄ‡∏õ‡πá‡∏ô ${newRole.toUpperCase()} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, false);
                    renderAdminUserList();
                } catch (error) {
                    showCustomError("‚ùå Error updating user role: " + error.message);
                }
            }
        };

    </script>
</body>
</html>